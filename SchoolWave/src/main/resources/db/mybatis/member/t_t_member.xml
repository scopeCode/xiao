<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"><mapper namespace="com.xcrm.core.member">    <update id="batchDeleteMember">    	UPDATE t_t_member    	SET dataStatus = 0    	WHERE tenantId = #{tenantId}    	      AND id IN 			     <foreach item="item" collection="memberIds" open="(" separator=","                 close=")">                    #{item}                 </foreach>     </update>        <update id="batchDeleteMemberTagRelation">    	UPDATE t_t_member_tag_relation    	SET dataStatus = 0    	WHERE tenantId = #{tenantId}    	      AND memberId IN 			     <foreach item="item" collection="memberIds" open="(" separator=","                 close=")">                    #{item}                 </foreach>     </update>    	<resultMap id="MemberInfoResultMap" type="com.xcrm.mt.bis.member.vo.MemberResultInfoVo">		<result property="id" column="id" />		<result property="memberCardId" column="memberCardId" />		<result property="memberName" column="memberName" />		<result property="nick" column="nick" />		<result property="headImage" column="headImage" />		<result property="tenantId" column="tenantId" />		<result property="balance" column="balance" />		<result property="debtBalance" column="debtBalance" />		<result property="totalPoint" column="totalPoint" />		<result property="leftPoint" column="leftPoint" />		<result property="mobile" column="mobile" />		<result property="birthday" column="birthday" />		<result property="sex" column="sex" />		<result property="address" column="address" />		<result property="remark" column="remark" />		<result property="levelName" column="levelName" />		<result property="levelId" column="level" />		<result property="source" column="source" />		<result property="created" column="created" />		<collection property="tagList" ofType="java.util.HashMap">		     <result property="tagName" column="tagName" />		     <result property="color" column="color" />		     <result property="id" column="tagId" />		</collection>		<collection property="anniversaryList" ofType="java.util.HashMap">		     <result property="anniversaryName" column="anniversaryName" />		     <result property="anniversaryDate" column="anniversaryDate" />		     <result property="id" column="anniversaryId" />		</collection>	</resultMap>		<select id="queryMember" resultMap="MemberInfoResultMap">		SELECT a.id,a.memberCardId,nick,memberName,headImage,a.tenantId,balance,debtBalance,totalPoint,leftPoint,mobile,birthday,sex,address,remark,			b.id as anniversaryId,anniversaryName,anniversaryDate,tagId,tagName,color,levelName,level,source,a.created		FROM t_t_member a 		LEFT JOIN t_t_member_anniversary b ON a.id = b.memberId AND a.tenantId = b.tenantId AND b.dataStatus = 1		LEFT JOIN t_t_member_tag_relation c ON a.id = c.memberId AND a.tenantId = c.tenantId AND c.dataStatus = 1		LEFT JOIN t_t_member_tag d ON d.id = c.tagId  AND d.tenantId = c.tenantId  AND d.dataStatus = 1		LEFT JOIN t_t_member_point_level e ON e.tenantId = a.tenantId AND a.level = e.id AND e.dataStatus = 1		WHERE a.tenantId = #{tenantId} AND a.id = #{memberId} AND a.dataStatus = 1	</select>		<resultMap id="MemberListResultMap" type="com.xcrm.mt.bis.member.vo.MemberListResultInfoVo">		<result property="id" column="id" />		<result property="memberCardId" column="memberCardId" />		<result property="memberName" column="memberName" />		<result property="headImage" column="headImage" />		<result property="nick" column="nick" />		<result property="mobile" column="mobile" />		<result property="levelName" column="levelName" />		<result property="tagName" column="tagName" />	</resultMap>		<select id="queryMemberList" resultMap="MemberListResultMap">		SELECT a.id,a.memberCardId,a.memberName,a.headImage,a.nick,a.mobile,d.levelName,GROUP_CONCAT(c.tagName SEPARATOR '、') AS tagName		FROM t_t_member a 		LEFT JOIN t_t_member_tag_relation b ON a.id = b.memberId AND b.tenantId = a.tenantId AND b.dataStatus =1 		LEFT JOIN t_t_member_tag c ON c.id = b.tagId AND c.tenantId = b.tenantId AND c.dataStatus = 1		LEFT JOIN t_t_member_point_level d ON a.level = d.id AND d.tenantId = a.tenantId AND d.dataStatus = 1 		WHERE a.dataStatus =  1 AND a.tenantId = #{tenantId} 		<if test="queryKey != null" >			<trim prefix="AND (" suffix=")">					a.memberCardId = LPAD(#{queryKey}, 8, 0) OR a.memberName like CONCAT('%',#{queryKey},'%')  OR a.mobile like CONCAT('%',#{queryKey},'%')			</trim>		</if>		GROUP BY a.id		ORDER BY a.created DESC		<if test="start != null and start >= 0 and pageSize != null and pageSize >= 0">			LIMIT #{start},#{pageSize}		</if>		<if test="start != null and start > 0 and pageSize == null">			LIMIT #{pageSize}		</if>	</select>		<resultMap id="MemberSearchListResultMap" type="com.xcrm.mt.bis.member.vo.MemberSearchListResultVo">		<result property="id" column="id" />		<result property="memberCardId" column="memberCardId" />		<result property="memberName" column="memberName" />		<result property="headImage" column="headImage" />		<result property="mobile" column="mobile" />		<result property="levelName" column="levelName" />		<result property="tagName" column="tagName" />		<result property="balance" column="balance" />		<result property="leftPoint" column="leftPoint" />		<result property="source" column="source" />		<result property="lastOrderDay" column="lastOrderDay" />	</resultMap>		<select id="searchMemberList" resultMap="MemberSearchListResultMap">		SELECT a.id,a.memberCardId,a.memberName,a.headImage,a.mobile,d.levelName,		       GROUP_CONCAT(CONCAT(c.tagName,'@',c.color) SEPARATOR '、') AS tagName,		       balance,leftPoint,source,DATEDIFF(NOW(),lastOrderDate) AS lastOrderDay		FROM t_t_member a 		LEFT JOIN t_t_member_tag_relation b ON a.id = b.memberId AND b.tenantId = a.tenantId AND b.dataStatus =1 		LEFT JOIN t_t_member_tag c ON c.id = b.tagId AND c.tenantId = b.tenantId AND c.dataStatus = 1		LEFT JOIN t_t_member_point_level d ON a.level = d.id AND d.tenantId = a.tenantId AND d.dataStatus = 1 		WHERE a.dataStatus =  1 AND a.tenantId = #{tenantId} 		<if test="queryKey != null" >			<trim prefix="AND (" suffix=")">					a.memberCardId = LPAD(#{queryKey}, 8, 0) OR a.memberName like CONCAT(#{queryKey},'%')  OR a.mobile = #{queryKey}			</trim>		</if>		<if test="levelId != null " >			AND a.level = #{levelId}		</if>		<if test="tagId != null" >			AND b.tagId = #{tagId}		</if>		<if test="source != null" >			AND a.source = #{source}		</if>		<if test="lastOrderDayInfo != null and lastOrderDayInfo > 0" >			AND DATEDIFF(NOW(),lastOrderDate) &lt;= #{lastOrderDayInfo}		</if>		GROUP BY a.id		<choose>			<when test="dataOrderId != null and dataOrderId == 1 ">				<choose>				   <when test="dataOrderType != null and dataOrderType == 1">				   	  ORDER BY a.level DESC,a.id ASC				   </when>				   <otherwise>				      ORDER BY a.level ASC,a.id ASC				   </otherwise>				</choose>			</when>						<when test="dataOrderId != null and dataOrderId == 2 ">				<choose>				   <when test="dataOrderType != null and dataOrderType == 1">				   	  ORDER BY a.leftPoint DESC,a.id ASC				   </when>				   <otherwise>				      ORDER BY a.leftPoint ASC,a.id ASC				   </otherwise>				</choose>			</when>						<when test="dataOrderId != null and dataOrderId == 3 ">				<choose>				   <when test="dataOrderType != null and dataOrderType == 1">				   	  ORDER BY a.balance DESC,a.id ASC				   </when>				   <otherwise>				      ORDER BY a.balance ASC,a.id ASC				   </otherwise>				</choose>			</when>						<when test="dataOrderId != null and dataOrderId == 4 ">				<choose>				   <when test="dataOrderType != null and dataOrderType == 1">				   	  ORDER BY a.source DESC,a.id ASC				   </when>				   <otherwise>				      ORDER BY a.source ASC,a.id ASC				   </otherwise>				</choose>			</when>						<when test="dataOrderId != null and dataOrderId == 5 ">				<choose>				   <when test="dataOrderType != null and dataOrderType == 1">				   	  ORDER BY DATEDIFF(NOW(),lastOrderDate) DESC,a.id ASC				   </when>				   <otherwise>				      ORDER BY DATEDIFF(NOW(),lastOrderDate) ASC,a.id ASC				   </otherwise>				</choose>			</when>			<otherwise>ORDER BY a.created DESC</otherwise>		</choose>				<if test="start != null and start >= 0 and pageSize != null and pageSize >= 0">			LIMIT #{start},#{pageSize}		</if>		<if test="start != null and start > 0 and pageSize == null">			LIMIT #{pageSize}		</if>	</select>			<select id="searchMemberList_count" resultType="java.lang.Integer">		SELECT COUNT(DISTINCT a.id)		FROM t_t_member a 		LEFT JOIN t_t_member_tag_relation b ON a.id = b.memberId AND b.tenantId = a.tenantId AND b.dataStatus =1 		LEFT JOIN t_t_member_tag c ON c.id = b.tagId AND c.tenantId = b.tenantId AND c.dataStatus = 1		WHERE a.dataStatus =  1 AND a.tenantId = #{tenantId} 		<if test="queryKey != null" >			<trim prefix="AND (" suffix=")">					a.memberCardId = LPAD(#{queryKey}, 8, 0) OR a.memberName like CONCAT('%',#{queryKey},'%')  OR a.mobile = #{queryKey}			</trim>		</if>		<if test="levelId != null " >			AND a.level = #{levelId}		</if>		<if test="tagId != null" >			AND b.tagId = #{tagId}		</if>		<if test="source != null" >			AND a.source = #{source}		</if>		<if test="lastOrderDayInfo != null and lastOrderDayInfo > 0" >			AND DATEDIFF(NOW(),lastOrderDate) &lt;= #{lastOrderDayInfo}		</if>	</select>		<update id="updateMemberPoint">		UPDATE t_t_member		SET leftPoint = leftPoint - #{exchangePoint} 		WHERE leftPoint >= #{exchangePoint} AND tenantId = #{tenantId} AND id = #{memberId} AND dataStatus = 1	</update>		<select id="queryCustomMemberCardId" resultType="java.lang.Long">		SELECT memberCardId		FROM t_t_member a 		WHERE a.tenantId = #{tenantId} AND isCustomCardId = 1 AND memberCardId &gt;= #{memberCardId}	</select></mapper>